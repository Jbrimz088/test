<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>J-TV Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
        .video-js { width: 100vw; height: 100vh; }
        
        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            text-align: center;
            pointer-events: none;
        }
        
        /* Focus state for TV Remotes */
        .vjs-big-play-button:focus { outline: 4px solid #fff; }
    </style>
</head>
<body>

    <div id="status">Initializing...</div>

    <video id="jtv-player" class="video-js vjs-big-play-centered" controls autoplay preload="auto">
    </video>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script>
        const WORKER_URL = "https://black-wildflower-8690.jcbrimley.workers.dev/";

        /* 1. GET THE ID AND CLEAN THE SLASHES */
        function getCleanID() {
            const urlParams = new URLSearchParams(window.location.search);
            let id = urlParams.get('id');

            // If browser made it ?id=12345/ -> change to 12345
            if (id && id.endsWith('/')) {
                id = id.slice(0, -1);
            }

            // Backup check if URL is messy
            if (!id) {
                const match = window.location.href.match(/[?&]id=([0-9]+)/);
                if (match) id = match[1];
            }
            return id;
        }

        async function startPlayer() {
            const status = document.getElementById('status');
            const movieID = getCleanID();

            if (!movieID) {
                status.innerHTML = "<h1>ERROR: No ID found.</h1><p>Use: test.html?id=1084242</p>";
                return;
            }

            status.textContent = "Grabbing stream for ID: " + movieID + "...";

            try {
                // 2. TALK TO YOUR WORKER
                const response = await fetch(`${WORKER_URL}?id=${movieID}`);
                const data = await response.json();

                if (data.url) {
                    status.style.display = "none"; // Hide status when video loads
                    
                    const player = videojs('jtv-player');
                    player.src({
                        src: data.url,
                        type: 'application/x-mpegURL'
                    });
                    
                    // Auto-play handling for some browsers
                    player.play().catch(e => {
                        status.style.display = "block";
                        status.textContent = "Click Play to Start";
                    });

                } else {
                    status.textContent = "Error: Worker couldn't find a file link.";
                }
            } catch (err) {
                console.error(err);
                status.textContent = "Connection Error. Check Worker status.";
            }
        }

        // Start when page loads
        document.addEventListener("DOMContentLoaded", startPlayer);
    </script>
</body>
</html>
